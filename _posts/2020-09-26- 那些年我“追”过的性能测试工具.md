---
layout:     post
title:      那些年我“追”过的性能测试工具
subtitle:   移动端性能测试
date:       2020-09-26
author:     Maomao
header-img: img/post-bg-android.jpg
catalog: true
tags:
    - 测试技术
---


## 那些年我“追”过的性能测试工具

### 1.道阻且长

在介绍我所用过或者说了解过的性能测试工具之前，必要的一点是了解我们在做移动端的性能测试的时候，我们想要什么？或者说为什么我们要做性能测试？

最直接的性能测试场景当然就是真实的用户场景，但是用户场景依赖于版本灰度or发布之后的数据上报，在研发流程内部版本发布之前如何有效的管控性能风险，提前发现可能存在的性能问题，就是我们常说的性能测试了，一般来说研发流程内的移动端的性能测试无非是两种情况：

- 监控重点的场景性能，助力产品提升体验.包括制定一些可量化的指标，牵引用户体验不断优化

- 发现可能存在的性能问题，降低版本发布中可能存在的性能质量风险.此种情况主要是通过制定性能基线或要求，通过观测版本间的性能数据波动，分析是否引入了新的性能问题。

针对上诉两种情况，如果要开展高效的性能测试工作，有几个方面是必不可少的：

- 性能的采集工具
- 性能的展示平台
- 自动化的性能套件
- 性能测试任务的管理平台

而在上诉几个方面中，性能测试最重要的基石就是采集工具，有了采集工具的，性能的数据才得以产出，性能测试也才有可能有一个“盖棺定论”的结果。下面我会以性能采集工具为基础，介绍几款相关的移动端性能采集工具，这些工具有的只能支持单一的采集功能，有的在采集的基础上添加了数据整理等功能，有的提供了平台化展示的功能，孰优孰劣，也许不同的产品也会有不一样的需求。

### 2.基础性能命令套件
*永不过时的小米加步枪*

不管是什么平台，其底层支撑的操作系统一定支持性能数据的查看读取等功能。以安卓为例，其底层就是一个Linux系统，所以要说如何获取应用的性能，直接按照Linux的方法来玩就好了。同时google在这个基础上也提供了诸如dumpsys等功能，基本上我们想要的性能数据，都可以通过操作系统底层获取。
举一个最简单的例子，获取应用的CPU占用率。

    adb shell top | grep "包名"
一行简单的代码就可以看到“最真实”的应用CPU占用率，同时也可以通过top命令查看机器的整体负载等等。

我们执行一个定义好的性能场景，执行命令并对这个命令行的输出做格式化处理，整合成为一个数据表格，一次最简单的应用性能测试就完成了。

其他的所需要的性能工具，就看项目的需求进行完善了，比如说性能的自动化执行，性能数据可视化，性能任务管理等等。

基础命令套件往往是在其他工具碰壁了仍然可以回来的一个方法，因为他的可操作性强，系统支持度高，几乎所有的系统都需要支持这个

> 要不然系统你们说我们应用CPU占用高你们自己怎么证明呢？

而且如果只是想完成一次的性能测试的话，这个方法的投入产出比也不会太低。

但是小米加步枪的方法并不适用于持续不断迭代的产品节奏，项目的初期我们可以通过这种方法快速构建，但是当项目的车轮开始跑起来之后，我们势必要想办法解决效率的问题。


### 3.GTSDK

*小试牛刀的GT*

基于底层命令式的套件需要大量的二次开发和处理，同时也存在数据可视化的一系列问题。于是我们在想，能否有一个sdk，帮我们把和底层交互的事情都帮我做了，给我提供性能获取的接口，我在上层直接调用驱动数据采集就行了呢？

对了，这个就是gtsdk做的事情，gt就是一个性能采集的sdk（当然也集成了其他的一些还不错的测试插件，比如说抓包—这个还得以来机器root，比较难受），gt将和安卓底层交互的接口封装，提供了CPU、内存、FPS（在FPS这块儿，GT也尝试将帧数绘制时间等用算法归一化，形成GT定义的流畅度数据SM）、流量等性能数据采集的接口，用户可以自行调用，也可以通过简单的图形操作界面进行测试采集。

车联网在2017年的时候性能自动化就是基于gtsdk构建的，自动化测试上使用基于uiautomator的自动化测试框架，同时自己也开发了一套可以脱机化的任务管理工具**小松鼠**整体来说性能测试运行的稳定性还不错。

不过随着车联的业务发展，车联接入的车型类型越来越多，车机系统也是纷繁多样，如同手机一般，越来越多的车机厂商也开始严格控制车载系统的root权限了，gtsdk在性能数据采集中对root权限的依赖，以及gt本身对于安卓新版本的适配，使得基于gt的性能自动化开始跟不上项目的脚步，甚至还有一些车机系统不支持gt软件的安装（比如广汽某车型系统）。车联网对于性能测试工具的通用性能力重新做了一次审视。

[GT官网-已下线](gt.qq.com)

GT已经开源，感兴趣的也可以看下GT的源代码
[GT-github](https://github.com/Tencent/GT)


### 4.Perfdog
*集大成者的Perfdog*

当我第一次看到perfdog的时候，给我的感觉是，这已经不仅仅是一个性能测试的工具了，而是一个可以独立推出的产品。事实上，最近perfdog确实已经走上了“国际化”的道路并且有了海外的官网。

这个工具的成熟度已经相当可以了，基本傻瓜式的性能数据采集操作（有windows和mac端），一些性能测试基本痛点的攻克：脱离机器root权限，性能数据的采集的可用性，数据可视化的效果，任务管理权限管理等等，这些perfdog都做完了。此外，由于perfdog早期是为游戏产品服务，所以其对于fps，流畅度有一套极具深度的探索（这么写的原因其实是因为我还没玩透）。

perfdog也提供perfdog service采集内核，提供给需要将性能测试自动化和数据展示串联到一起的同学。本质上来说perfdog service内核所提供的功能就是一个相对高阶的gtsdk，但是其配套的数据展示和项目任务管理就是让你无法拒绝perfdog的一个原因。

> 那么，代价是什么呢？古尔丹

你可能会这么问，获得了好处，那就必然也会有一些缺憾。Perfdog并不支持多进程同时采集，每次只能采集一个进程的数据（注意这里并不是说多应用），这个对于我们来说还是比较难受的一个点，毕竟车联的应用，除了基础的主进程之外，语音和小程序的进程也是我们需要关注的重点。还有比如说perfdog性能数据的展示相对格式化，并没有支持定制的空间。还有就是perfdog更多的是支撑研发数据资源消耗类性能测试的组件，对于用户体验性能（比如说启动速度）并不支持等等。

[perfdog官网](https://perfdog.qq.com/)


### 5.QAPM
*剑走偏锋，QAPM*

和本片文章的其他几个工具都不一样，QAPM从本质上来说并不是一个存粹的性能测试工具，或者说不是我们本篇想要讨论的研发流程内部的性能测试工具。但是他**也许**在某些场景可以提供一些意想不到的性能测试便利。

其他几项工具，都是应用之外的工具，有点像是检测员的角色，应用上了系统就向上了流水线，性能测试的工具就是流水线上的质检员，可以随时检测此时此刻应用的性能情况。

而QAPM不一样，他需要研发在编码的时候就将性能采集的方法嵌入工程中，这样在代码调用到某一行的时候自动就开始了性能采集工作，同时将相关的性能数据直接回传到了apm的管理平台。这里所有的场景定义、采集触发和结束、性能数据回传和展示都交给了apm来完成，测试人员需要做的也许就只是动动手指点一下，数据就回来了。同时QAPM也支持一些特殊性能数据的采集和回传，比如最经典的用户体验性能之一**应用启动速度**可以很好的通过apm来实现。

QAPM的原理我尚不太清楚，但是其所提供的能力，还是有非常可观的想象空间的，记得很早的时候听过一句话：当你的产品做的足够好的时候，你就不太可能能从研发流程内的性能测试场景中发现问题了，这个时候你需要的就是全量用户给你提供的数据，这是其一。当采集的代码直接嵌入在研发工程中，这个从某一方面来说是大量节省了可能存在的性能测试中的适配工作，采集的适配，自动化测试的适配等等。

当然代码写到项目里也会有一些弊端
- 比如有没有可能采集本身会影响应用的性能
- 比如当我们需要做竞品测试的时候，这种方法势必无法完成？
- 比如当两个不同的性能场景需要调用同一行代码的时候，如何对这两个场景进行区分？
- 比如不断迭代的过程中场景也会不断的更新，或者研发代码重构之后对于新老版本的性能数据是否还具备可对比性？

也许这些都是在使用QAPM需要思考和解决的问题。


